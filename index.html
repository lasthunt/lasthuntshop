
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- EmailJS for sending emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" id="loginContainer">
        <div class="login-container">
            <h1>Admin Login</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <div class="container" id="adminPanel" style="display:none">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Admin Dashboard</h1>
            <button class="btn btn-danger" id="logoutBtn">Logout</button>
        </div>
        
        <div class="admin-section">
            <h2>Discount Management</h2>
            <form id="discountForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Discount Percentage</label>
                        <input type="number" id="discountPercentage" min="0" max="100" step="1" required>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="submit" class="btn btn-primary">Update Discount</button>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="admin-section">
            <h2>Product Management</h2>
            <button class="btn btn-primary" id="addProductBtn">Add New Product</button>
            
            <div id="productForm" style="display:none; margin-top:20px">
                <form id="editProductForm">
                    <input type="hidden" id="productId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="productCategory" required>
                                <option value="electronics">Electronics</option>
                                <option value="fashion">Fashion</option>
                                <option value="home">Home & Garden</option>
                                <option value="toys">Toys</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Price (MVR)</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Original Price (MVR)</label>
                            <input type="number" id="productOriginalPrice" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="productImage" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="productDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productFeatured"> Featured Product
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                    <button type="button" class="btn btn-danger" id="cancelEdit">Cancel</button>
                </form>
            </div>
            
            <table id="productsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Featured</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsList">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="admin-section">
            <h2>Used Items Management</h2>
            <button class="btn btn-primary" id="addUsedItemBtn">Add Used Item</button>
            
            <div id="usedItemForm" style="display:none; margin-top:20px">
                <form id="editUsedItemForm">
                    <input type="hidden" id="usedItemId">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="usedItemName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Price (MVR)</label>
                            <input type="number" id="usedItemPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Island</label>
                            <select id="usedItemIsland" required>
                                <option>Feeali</option>
                                <option>Biledhoo</option>
                                <option>Dharaboodhoo</option>
                                <option>Magoodhoo</option>
                                <option>Nilandhoo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contact Number</label>
                        <input type="tel" id="usedItemContact" required>
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="usedItemImage">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="usedItemDescription"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                    <button type="button" class="btn btn-danger" id="cancelUsedItemEdit">Cancel</button>
                </form>
            </div>
            
            <table id="usedItemsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Island</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usedItemsList">
                    <!-- Used items will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Order Management</h2>
                <div>
                    <select id="orderStatusFilter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="completed">Completed</option>
                    </select>
                    <button class="btn btn-primary" id="refreshOrdersBtn" style="margin-left: 10px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersList">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
            
            <div id="orderDetailsPanel" class="order-details-panel" style="display: none;">
                <h3>Order Details</h3>
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
                <div id="emailStatus" style="margin-top: 15px; display: none;"></div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="closeOrderDetails">Close Details</button>
                    <button class="btn btn-info" id="sendEmailBtn" style="margin-left: 10px;">
                        <i class="fas fa-envelope"></i> Send Order Details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image preview modal -->
    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqdg6ePdCGvlzHpaEFgOUFPaHEsPYIApw",
            authDomain: "operationinterectiondata.firebaseapp.com",
            databaseURL: "https://operationinterectiondata-default-rtdb.firebaseio.com",
            projectId: "operationinterectiondata",
            storageBucket: "operationinterectiondata.appspot.com",
            messagingSenderId: "211887231593",
            appId: "1:211887231593:web:aac4253ab20803876348f8",
            measurementId: "G-HSL5TF5FTB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Initialize EmailJS with your public key
        emailjs.init('YOUR_EMAILJS_PUBLIC_KEY'); // Replace with your actual EmailJS public key

        // Admin credentials
        const ADMIN_USERNAME = "Admin";
        const ADMIN_PASSWORD = "Admin123";

        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const productsList = document.getElementById('productsList');
        const usedItemsList = document.getElementById('usedItemsList');
        const ordersList = document.getElementById('ordersList');
        const productForm = document.getElementById('productForm');
        const usedItemForm = document.getElementById('usedItemForm');
        const editProductForm = document.getElementById('editProductForm');
        const editUsedItemForm = document.getElementById('editUsedItemForm');
        const addProductBtn = document.getElementById('addProductBtn');
        const addUsedItemBtn = document.getElementById('addUsedItemBtn');
        const cancelEdit = document.getElementById('cancelEdit');
        const cancelUsedItemEdit = document.getElementById('cancelUsedItemEdit');
        const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
        const orderStatusFilter = document.getElementById('orderStatusFilter');
        const orderDetailsPanel = document.getElementById('orderDetailsPanel');
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        const closeOrderDetails = document.getElementById('closeOrderDetails');
        const sendEmailBtn = document.getElementById('sendEmailBtn');
        const emailStatus = document.getElementById('emailStatus');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.querySelector('.close-modal');
        const discountForm = document.getElementById('discountForm');
        const discountPercentageInput = document.getElementById('discountPercentage');

        // App state
        let state = {
            products: [],
            usedItems: [],
            orders: [],
            selectedOrder: null
        };

        // Initialize
        function init() {
            // Check if already logged in
            auth.onAuthStateChanged(user => {
                if (user && localStorage.getItem('adminLoggedIn') === 'true') {
                    showAdminPanel();
                    loadProducts();
                    loadUsedItems();
                    loadOrders();
                    loadDiscount();
                } else {
                    showLoginPanel();
                }
            });

            // Event listeners
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            addProductBtn.addEventListener('click', showAddProductForm);
            addUsedItemBtn.addEventListener('click', showAddUsedItemForm);
            cancelEdit.addEventListener('click', hideProductForm);
            cancelUsedItemEdit.addEventListener('click', hideUsedItemForm);
            editProductForm.addEventListener('submit', saveProduct);
            editUsedItemForm.addEventListener('submit', saveUsedItem);
            refreshOrdersBtn.addEventListener('click', loadOrders);
            orderStatusFilter.addEventListener('change', renderOrders);
            closeOrderDetails.addEventListener('click', () => {
                orderDetailsPanel.style.display = 'none';
            });
            sendEmailBtn.addEventListener('click', sendOrderEmail);
            closeModal.addEventListener('click', () => {
                imageModal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });
            discountForm.addEventListener('submit', updateDiscount);
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Simulate admin login (in a real app, this would be server-side)
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
                loadProducts();
                loadUsedItems();
                loadOrders();
                loadDiscount();
            } else {
                alert('Invalid credentials');
            }
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('adminLoggedIn');
            showLoginPanel();
        }

        // Show admin panel
        function showAdminPanel() {
            loginContainer.style.display = 'none';
            adminPanel.style.display = 'block';
        }

        // Show login panel
        function showLoginPanel() {
            loginContainer.style.display = 'block';
            adminPanel.style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Load discount from Firebase
        function loadDiscount() {
            database.ref('discount').on('value', (snapshot) => {
                const discountData = snapshot.val();
                if (discountData) {
                    discountPercentageInput.value = discountData.percentage || 0;
                } else {
                    discountPercentageInput.value = 0;
                }
            });
        }

        // Update discount
        function updateDiscount(e) {
            e.preventDefault();
            const percentage = parseInt(discountPercentageInput.value) || 0;
            
            database.ref('discount').set({ percentage })
                .then(() => {
                    alert('Discount updated successfully!');
                })
                .catch(error => {
                    alert('Error updating discount: ' + error.message);
                });
        }

        // Load products from Firebase
        function loadProducts() {
            database.ref('products').on('value', (snapshot) => {
                const productsData = snapshot.val();
                if (productsData) {
                    state.products = Object.entries(productsData).map(([id, product]) => ({
                        id,
                        ...product
                    }));
                    renderProducts();
                } else {
                    state.products = [];
                    renderProducts();
                }
            });
        }

        // Load used items from Firebase
        function loadUsedItems() {
            database.ref('usedItems').on('value', (snapshot) => {
                const usedItemsData = snapshot.val();
                if (usedItemsData) {
                    state.usedItems = Object.entries(usedItemsData).map(([id, item]) => ({
                        id,
                        ...item
                    }));
                    renderUsedItems();
                } else {
                    state.usedItems = [];
                    renderUsedItems();
                }
            });
        }

        // Load orders from Firebase
        function loadOrders() {
            database.ref('orders').on('value', (snapshot) => {
                const ordersData = snapshot.val();
                if (ordersData) {
                    state.orders = Object.entries(ordersData).map(([id, order]) => ({
                        id,
                        ...order
                    }));
                    renderOrders();
                } else {
                    state.orders = [];
                    renderOrders();
                }
            });
        }

        // Product management
        function showAddProductForm() {
            editProductForm.reset();
            document.getElementById('productId').value = '';
            productForm.style.display = 'block';
        }
        
        function hideProductForm() {
            productForm.style.display = 'none';
        }
        
        function editProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productOriginalPrice').value = product.original_price || '';
            document.getElementById('productImage').value = product.image;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productFeatured').checked = product.featured || false;
            
            productForm.style.display = 'block';
        }
        
        function saveProduct(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                original_price: parseFloat(document.getElementById('productOriginalPrice').value) || null,
                image: document.getElementById('productImage').value,
                description: document.getElementById('productDescription').value,
                featured: document.getElementById('productFeatured').checked
            };
            
            const productId = document.getElementById('productId').value;
            
            if (productId) {
                // Update existing product
                database.ref(`products/${productId}`).update(product)
                    .then(() => {
                        hideProductForm();
                    })
                    .catch(error => {
                        alert('Error updating product: ' + error.message);
                    });
            } else {
                // Add new product
                database.ref('products').push(product)
                    .then(() => {
                        hideProductForm();
                    })
                    .catch(error => {
                        alert('Error adding product: ' + error.message);
                    });
            }
        }
        
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                database.ref(`products/${productId}`).remove()
                    .catch(error => {
                        alert('Error deleting product: ' + error.message);
                    });
            }
        }
        
        function renderProducts() {
            productsList.innerHTML = state.products.map(product => `
                <tr>
                    <td>${product.id.substring(0, 8)}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>MVR${product.price.toFixed(2)}</td>
                    <td>${product.featured ? 'Yes' : 'No'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Used items management
        function showAddUsedItemForm() {
            editUsedItemForm.reset();
            document.getElementById('usedItemId').value = '';
            usedItemForm.style.display = 'block';
        }
        
        function hideUsedItemForm() {
            usedItemForm.style.display = 'none';
        }
        
        function editUsedItem(itemId) {
            const item = state.usedItems.find(i => i.id === itemId);
            if (!item) return;
            
            document.getElementById('usedItemId').value = item.id;
            document.getElementById('usedItemName').value = item.name;
            document.getElementById('usedItemPrice').value = item.price;
            document.getElementById('usedItemIsland').value = item.island;
            document.getElementById('usedItemContact').value = item.contact;
            document.getElementById('usedItemImage').value = item.image || '';
            document.getElementById('usedItemDescription').value = item.description || '';
            
            usedItemForm.style.display = 'block';
        }
        
        function saveUsedItem(e) {
            e.preventDefault();
            
            const usedItem = {
                name: document.getElementById('usedItemName').value,
                price: parseFloat(document.getElementById('usedItemPrice').value),
                island: document.getElementById('usedItemIsland').value,
                contact: document.getElementById('usedItemContact').value,
                image: document.getElementById('usedItemImage').value || null,
                description: document.getElementById('usedItemDescription').value || null
            };
            
            const itemId = document.getElementById('usedItemId').value;
            
            if (itemId) {
                // Update existing item
                database.ref(`usedItems/${itemId}`).update(usedItem)
                    .then(() => {
                        hideUsedItemForm();
                    })
                    .catch(error => {
                        alert('Error updating used item: ' + error.message);
                    });
            } else {
                // Add new item
                database.ref('usedItems').push(usedItem)
                    .then(() => {
                        hideUsedItemForm();
                    })
                    .catch(error => {
                        alert('Error adding used item: ' + error.message);
                    });
            }
        }
        
        function deleteUsedItem(itemId) {
            if (confirm('Are you sure you want to delete this used item?')) {
                database.ref(`usedItems/${itemId}`).remove()
                    .catch(error => {
                        alert('Error deleting used item: ' + error.message);
                    });
            }
        }
        
        function renderUsedItems() {
            usedItemsList.innerHTML = state.usedItems.map(item => `
                <tr>
                    <td>${item.id.substring(0, 8)}</td>
                    <td>${item.name}</td>
                    <td>MVR${item.price.toFixed(2)}</td>
                    <td>${item.island}</td>
                    <td>${item.contact}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editUsedItem('${item.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUsedItem('${item.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Order management
        function viewOrderDetails(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            state.selectedOrder = order;
            
            // Generate items list for email template
            const itemsList = order.items.map(item => `
                <li>
                    ${item.product.name} (Qty: ${item.quantity}) - MVR${(item.product.price * item.quantity).toFixed(2)}
                </li>
            `).join('');
            
            orderDetailsContent.innerHTML = `
                <div class="order-details-row">
                    <div class="order-details-label">Order Number:</div>
                    <div>${order.orderNumber || order.id.substring(0, 8)}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Date:</div>
                    <div>${order.date || 'N/A'}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Status:</div>
                    <div>
                        <span class="status-badge status-${order.status}">
                            ${order.status}
                        </span>
                    </div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Payment Method:</div>
                    <div>${order.paymentMethod === 'bank_transfer' ? 'Bank Transfer' : 'Credit Card'}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Total Amount:</div>
                    <div>MVR${order.total.toFixed(2)}</div>
                </div>
                
                <h4 style="margin-top: 20px;">Customer Information</h4>
                <div class="order-details-row">
                    <div class="order-details-label">Name:</div>
                    <div>${order.shippingInfo?.name || 'N/A'}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Email:</div>
                    <div>${order.shippingInfo?.email || 'N/A'}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Phone:</div>
                    <div>${order.shippingInfo?.phone || 'N/A'}</div>
                </div>
                <div class="order-details-row">
                    <div class="order-details-label">Address:</div>
                    <div>
                        ${order.shippingInfo?.address || ''}<br>
                        ${order.shippingInfo?.city || ''}, ${order.shippingInfo?.state || ''} ${order.shippingInfo?.postalCode || ''}<br>
                        ${order.shippingInfo?.country || ''}
                    </div>
                </div>
                
                <div class="order-items">
                    <h4>Order Items</h4>
                    ${order.items.map(item => `
                        <div class="order-item">
                            <span>${item.product.name} x ${item.quantity}</span>
                            <span>MVR${(item.product.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="order-item" style="font-weight: bold; border-top: 1px solid #ddd; margin-top: 5px;">
                        <span>Total:</span>
                        <span>MVR${order.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${order.paymentMethod === 'bank_transfer' ? `
                <div class="payment-slip">
                    <h4>Bank Transfer Details</h4>
                    <p>Payment slip: ${order.paymentSlip ? 'Uploaded' : 'Not uploaded'}</p>
                    ${order.paymentSlip ? `
                        <p>Click to view payment slip:</p>
                        <img src="${order.paymentSlip}" alt="Payment Slip" 
                             onclick="openImageModal('${order.paymentSlip}')"
                             style="cursor: pointer; max-width: 200px;">
                    ` : ''}
                </div>
                ` : ''}
                
                <div id="emailTemplateData" style="display:none;">
                    <div id="customerName">${order.shippingInfo?.name || 'Customer'}</div>
                    <div id="orderNumber">${order.orderNumber || order.id.substring(0, 8)}</div>
                    <div id="orderDate">${order.date || 'N/A'}</div>
                    <div id="orderStatus">${order.status}</div>
                    <div id="orderTotal">MVR${order.total.toFixed(2)}</div>
                    <div id="paymentMethod">${order.paymentMethod === 'bank_transfer' ? 'Bank Transfer' : 'Credit Card'}</div>
                    <ul id="orderItemsList">${itemsList}</ul>
                </div>
            `;
            
            orderDetailsPanel.style.display = 'block';
            emailStatus.style.display = 'none';
        }
        
        // Open image in modal
        function openImageModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.style.display = 'block';
        }
        
        // Update order status
        function updateOrderStatus(orderId, status) {
            database.ref(`orders/${orderId}/status`).set(status)
                .then(() => {
                    // If status is updated to approved or completed, send email notification
                    if (status === 'approved' || status === 'completed') {
                        const order = state.orders.find(o => o.id === orderId);
                        if (order && order.shippingInfo?.email) {
                            sendStatusEmail(order, status);
                        }
                    }
                })
                .catch(error => {
                    alert('Error updating order status: ' + error.message);
                });
        }
        
        // Delete order
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                database.ref(`orders/${orderId}`).remove()
                    .then(() => {
                        orderDetailsPanel.style.display = 'none';
                    })
                    .catch(error => {
                        alert('Error deleting order: ' + error.message);
                    });
            }
        }
        
        // Send order details email
        function sendOrderEmail() {
            if (!state.selectedOrder) return;
            
            const order = state.selectedOrder;
            const customerEmail = order.shippingInfo?.email;
            
            if (!customerEmail) {
                emailStatus.innerHTML = '<div style="color: red;">No email address found for this order.</div>';
                emailStatus.style.display = 'block';
                return;
            }
            
            emailStatus.innerHTML = '<div class="spinner"></div><div>Sending email...</div>';
            emailStatus.style.display = 'block';
            
            // Prepare email template parameters
            const templateParams = {
                to_name: order.shippingInfo?.name || 'Customer',
                to_email: customerEmail,
                order_number: order.orderNumber || order.id.substring(0, 8),
                order_date: order.date || 'N/A',
                order_status: order.status,
                order_total: `MVR${order.total.toFixed(2)}`,
                payment_method: order.paymentMethod === 'bank_transfer' ? 'Bank Transfer' : 'Credit Card',
                items_list: order.items.map(item => 
                    `${item.product.name} (Qty: ${item.quantity}) - $${(item.product.price * item.quantity).toFixed(2)}`
                ).join('<br>'),
                customer_name: order.shippingInfo?.name || 'Customer',
                customer_email: customerEmail,
                customer_phone: order.shippingInfo?.phone || 'N/A',
                customer_address: `
                    ${order.shippingInfo?.address || ''}<br>
                    ${order.shippingInfo?.city || ''}, ${order.shippingInfo?.state || ''} ${order.shippingInfo?.postalCode || ''}<br>
                    ${order.shippingInfo?.country || ''}
                `
            };
            
            // Send email using EmailJS
            emailjs.send('YOUR_EMAILJS_SERVICE_ID', 'YOUR_EMAILJS_TEMPLATE_ID', templateParams)
                .then(() => {
                    emailStatus.innerHTML = '<div style="color: green;">Email sent successfully!</div>';
                })
                .catch(error => {
                    console.error('Email sending error:', error);
                    emailStatus.innerHTML = `<div style="color: red;">Failed to send email: ${error.text || error.message}</div>`;
                });
        }
        
        // Send status update email
        function sendStatusEmail(order, status) {
            const customerEmail = order.shippingInfo?.email;
            if (!customerEmail) return;
            
            const statusText = status === 'approved' ? 'approved' : 'completed';
            const subject = `Your Order #${order.orderNumber || order.id.substring(0, 8)} has been ${statusText}`;
            
            const templateParams = {
                to_name: order.shippingInfo?.name || 'Customer',
                to_email: customerEmail,
                subject: subject,
                order_number: order.orderNumber || order.id.substring(0, 8),
                order_status: status,
                message: `Your order has been ${statusText}. Thank you for shopping with us!`
            };
            
            emailjs.send('YOUR_EMAILJS_SERVICE_ID', 'YOUR_STATUS_EMAIL_TEMPLATE_ID', templateParams)
                .catch(error => {
                    console.error('Status email sending error:', error);
                });
        }
        
        // Render orders table
        function renderOrders() {
            const statusFilter = orderStatusFilter.value;
            let filteredOrders = state.orders;
            
            if (statusFilter !== 'all') {
                filteredOrders = state.orders.filter(order => order.status === statusFilter);
            }
            
            // Sort by date (newest first)
            filteredOrders.sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : new Date(0);
                const dateB = b.date ? new Date(b.date) : new Date(0);
                return dateB - dateA;
            });
            
            ordersList.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td>${order.orderNumber || order.id.substring(0, 8)}</td>
                    <td>${order.shippingInfo?.name || 'N/A'}</td>
                    <td>$${order.total.toFixed(2)}</td>
                    <td>${order.date || 'N/A'}</td>
                    <td>
                        <span class="status-badge status-${order.status}">
                            ${order.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('${order.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${order.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.id}', 'approved')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="updateOrderStatus('${order.id}', 'rejected')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            ` : ''}
                            ${order.status === 'approved' ? `
                                <button class="btn btn-primary btn-sm" onclick="updateOrderStatus('${order.id}', 'completed')">
                                    <i class="fas fa-check-circle"></i> Complete
                                </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="viewOrderDetails('${order.id}'); document.getElementById('sendEmailBtn').click();">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="deleteOrder('${order.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>